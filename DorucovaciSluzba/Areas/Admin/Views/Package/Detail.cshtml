@model DorucovaciSluzba.Domain.Entities.Zasilka
@{
    ViewData["Title"] = "Detail zásilky";
    var odesilatel = ViewBag.Odesilatel as DorucovaciSluzba.Infrastructure.Identity.User;
    var prijemce = ViewBag.Prijemce as DorucovaciSluzba.Infrastructure.Identity.User;
    var kuryr = ViewBag.Kuryr as DorucovaciSluzba.Infrastructure.Identity.User;
    var isRecipient = ViewBag.IsRecipient as bool? ?? false;
}

<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card border-0 shadow-lg rounded-4">
                <!-- HLAVIČKA -->
                <div class="card-header text-white text-center py-4 rounded-top-4" style="background: linear-gradient(135deg, #537280 0%, #6a8796 100%);">
                    <h3 class="mb-2 fw-bold">
                        <i class="fas fa-box me-2"></i>Zásilka číslo: @Model.Cislo
                    </h3>
                    <h5 class="mb-0">
                        <span class="badge bg-light text-dark px-3 py-2">@Model.Stav?.Stav</span>
                    </h5>
                </div>

                <div class="card-body p-4">
                    <!-- OBRÁZEK PODLE STAVU ZÁSILKY -->
                    <div class="text-center mb-4">
                        @{
                            string imageFileName = Model.StavId switch
                            {
                                1 => "vytvoreno.png",
                                2 => "prepravovano.png",
                                3 => "doruceno.png",
                                4 => "reklamovano.png",
                                _ => "vytvoreno.png"
                            };

                            string imagePath = Url.Content($"~/images/package-states/{imageFileName}");
                            string altText = Model.Stav?.Stav ?? "Zásilka";
                        }

                        <div class="rounded-4 p-4 bg-light">
                            <img src="@imagePath"
                                 alt="@altText"
                                 class="img-fluid"
                                 style="max-height: 350px; object-fit: contain;"
                                 onerror="this.onerror=null; this.src='/images/placeholder.png'; this.style.display='none'; this.nextElementSibling.style.display='block';" />
                            <div style="display: none;">
                                <i class="fas fa-image fa-5x text-muted"></i>
                                <p class="text-muted mt-3">Obrázek nenalezen: @imageFileName</p>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4" />

                    <!-- 3 SLOUPCE: ODESÍLATEL | PŘÍJEMCE | KURÝR -->
                    <div class="row text-center mb-4 g-3">

                        <!-- ODESÍLATEL -->
                        <div class="col-md-4">
                            <div class="card border-0 shadow h-100 rounded-4">
                                <div class="card-body p-3">
                                    <h5 class="text-primary mb-3 fw-bold">
                                        <i class="fas fa-user me-2"></i>Odesílatel
                                    </h5>
                                    <p class="mb-2 fw-semibold">@odesilatel?.FirstName @odesilatel?.LastName</p>
                                    <p class="mb-2 small text-muted">
                                        <i class="fas fa-envelope me-1"></i>@odesilatel?.Email
                                    </p>
                                    @if (!string.IsNullOrEmpty(odesilatel?.Ulice))
                                    {
                                        <p class="mb-0 small text-muted">
                                            <i class="fas fa-map-marker-alt me-1"></i>
                                            @odesilatel.Ulice @odesilatel.CP<br />
                                            @odesilatel.Mesto, @odesilatel.Psc
                                        </p>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- PŘÍJEMCE -->
                        <div class="col-md-4">
                            <div class="card border-2 border-success shadow h-100 rounded-4">
                                <div class="card-body p-3">
                                    <h5 class="text-success mb-3 fw-bold">
                                        <i class="fas fa-user-check me-2"></i>Příjemce
                                    </h5>
                                    <p class="mb-2 fw-semibold">@prijemce?.FirstName @prijemce?.LastName</p>
                                    <p class="mb-2 small text-muted">
                                        <i class="fas fa-envelope me-1"></i>@prijemce?.Email
                                    </p>
                                    <p class="mb-0 small text-muted">
                                        <i class="fas fa-map-marker-alt me-1 text-danger"></i>
                                        @Model.DestinaceUlice @Model.DestinaceCP<br />
                                        @Model.DestinaceMesto, @Model.DestinacePsc
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- KURÝR -->
                        <div class="col-md-4">
                            <div class="card border-0 shadow h-100 rounded-4">
                                <div class="card-body p-3">
                                    @if (kuryr != null)
                                    {
                                        <h5 class="text-warning mb-3 fw-bold">
                                            <i class="fas fa-truck me-2"></i>Kurýr
                                        </h5>
                                        <p class="mb-2 fw-semibold">@kuryr.FirstName @kuryr.LastName</p>
                                        <p class="mb-2 small text-muted">
                                            <i class="fas fa-envelope me-1"></i>@kuryr.Email
                                        </p>
                                        @if (!string.IsNullOrEmpty(kuryr.Telefon))
                                        {
                                            <p class="mb-0 small text-muted">
                                                <i class="fas fa-phone me-1"></i>@kuryr.Telefon
                                            </p>
                                        }
                                    }
                                    else
                                    {
                                        <h5 class="text-muted mb-3 fw-bold">
                                            <i class="fas fa-truck me-2"></i>Kurýr
                                        </h5>
                                        <p class="text-muted mb-0">Zatím nepřiřazen</p>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4" />

                    <!-- HISTORIE DORUČENÍ -->
                    <h5 class="mb-4 fw-bold">
                        <i class="fas fa-history me-2 text-primary"></i>Historie doručení
                    </h5>

                    @{
                        var historie = ViewBag.Historie as IList<DorucovaciSluzba.Domain.Entities.PackageHistoryItem>;
                        var vsechnyStavy = ViewBag.VsechnyStavy as IList<DorucovaciSluzba.Domain.Entities.StavZasilka>;
                        var aktualniStavId = Model.StavId;

                        if (vsechnyStavy != null && vsechnyStavy.Any())
                        {
                            var historieDict = historie?
                            .GroupBy(h => h.StavId)
                            .ToDictionary(g => g.Key, g => g.OrderByDescending(h => h.DatumZmeny).First())
                            ?? new Dictionary<int, DorucovaciSluzba.Domain.Entities.PackageHistoryItem>();

                            <!-- Vytvoření časové osy pro každý stav zásilky -->
                            <div class="package-timeline">
                                @for (int i = 0; i < vsechnyStavy.Count; i++)
                                {
                                    var stav = vsechnyStavy[i];
                                    var historyItem = historieDict.ContainsKey(stav.Id) ? historieDict[stav.Id] : null;

                                    bool isCompleted = historyItem != null && stav.Id != aktualniStavId;
                                    bool isCurrent = stav.Id == aktualniStavId;
                                    bool isFuture = historyItem == null && !isCurrent;
                                    bool isReclaimed = stav.Stav.Contains("Reklamováno") && isCurrent;

                                    // Vnořené podmínky pro určení CSS třídy -> reklamováno, aktuální, dokončené, budoucí
                                    var cssClass = isReclaimed ? "reclaimed" : (isCurrent ? "current" : (isCompleted ? "completed" : "future"));

                                    // Vykreslení položky časové osy -> barevně odlišené podle stavu (zelená, světle zelená, šedá, červená)
                                    // Bublina a text
                                    <div class="timeline-item @cssClass">
                                        <div class="timeline-badge @cssClass"></div>
                                        <div class="timeline-content">
                                            <div class="timeline-title">@stav.Stav</div>
                                            <div class="timeline-date">
                                                @if (historyItem != null)
                                                {
                                                    <i class="far fa-clock me-1"></i>
                                                    @historyItem.DatumZmeny.ToString("dd.MM.yyyy HH:mm")
                                                }
                                                else
                                                {
                                                    <span class="text-muted">---</span>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-info mb-0 rounded-4">
                                <i class="fas fa-info-circle me-2"></i>
                                Zatím nebyla zaznamenána žádná změna stavu.
                            </div>
                        }
                    }
                </div>

                <!-- FOOTER S TLAČÍTKY -->
                <div class="card-footer bg-light text-center py-4 border-0 rounded-bottom-4">
                    <div class="d-flex gap-3 justify-content-center flex-wrap">
                        <!-- Tlačítko pro změnu adresy - pro příjemce -->
                        @if (ViewBag.IsRecipient == true && Model.Stav?.Id != 3)
                        {
                            <a asp-area="Admin"
                               asp-controller="Package"
                               asp-action="ChangeAddress"
                               asp-route-id="@Model.Id"
                               class="btn btn-success btn-lg px-4">
                                <i class="fas fa-map-marker-alt me-2"></i>Změnit adresu doručení
                            </a>
                        }

                        <a asp-action="Track" class="btn btn-primary btn-lg px-4">
                            <i class="fas fa-search me-2"></i>Vyhledat jinou zásilku
                        </a>
                        <a asp-area="" asp-controller="Home" asp-action="Index" class="btn btn-secondary btn-lg px-4">
                            <i class="fas fa-home me-2"></i>Domů
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>